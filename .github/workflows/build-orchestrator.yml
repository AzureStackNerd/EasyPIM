
on:
  push:
    tags:
      - 'orchestrator-v*'
  workflow_dispatch:

jobs:
  build-orchestrator:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v1

      - name: Install EasyPIM Core from Gallery (v2.0.0-beta1)
        run: Install-Module -Name EasyPIM -RequiredVersion 2.0.0-beta1 -AllowPrerelease -Force -Scope CurrentUser
        shell: pwsh

      - name: Install Prerequisites
        run: .\build\vsts-prerequisites.ps1
        shell: pwsh

      - name: Validate
        run: .\build\vsts-validate.ps1
        shell: pwsh

      - name: Build Orchestrator
        run: .\EasyPIM.Orchestrator\build\vsts-build-orchestrator.ps1 -ApiKey $env:APIKEY
        shell: pwsh
        env:
          APIKEY: ${{ secrets.POWERSHELL_GALLERY_API_KEY }}
